<!DOCTYPE html>
<html>
<body>
<h2>Play Audio File: from local file, url or recording</h2>
<p>
<label for="url">Select Local File</label>
<input id="audio_file" type="file" accept="audio/*" />
<!-- <audio control id="audio_player" /> -->
</p>
<p>
<label for="url">or complete URL ("https://homes.esat.kuleuven.be/~spchlab/data/)  </label>
<input type="url" name="url" id="audio_url"
       placeholder="misc/splat.wav"
       pattern="https://.*" size="30"
       required>
</p>
<p>
<audio controls id="audio_player"></audio>
</p>
<p>
<button id="recordButton">Record</button>
<button id="stopButton" disabled>Stop</button>
</p>
<script>
var dir = "https://homes.esat.kuleuven.be/~spchlab/data/"
audio_file.onchange = function(){
    var files = this.files;
    var file = URL.createObjectURL(files[0]); 
    audio_player.src = file; 
    // audio_player.play();
};

audio_url.onchange = function(){
    var url = dir + this.value;
    // var file = URL.createObjectURL(files[0]); 
    audio_player.src = url; 
    // audio_player.play();
};

//webkitURL is deprecated but nevertheless
URL = window.URL || window.webkitURL;

var gumStream; 						//stream from getUserMedia()
var recorder; 						//MediaRecorder object
var chunks = [];					//Array of chunks of audio data from the browser
var extension;

const recordButton = document.getElementById("recordButton");
const stopButton = document.getElementById("stopButton");

//add events to those 2 buttons
recordButton.addEventListener("click", startRecording);
stopButton.addEventListener("click", stopRecording);

// true on chrome, false on firefox
console.log("audio/webm:"+MediaRecorder.isTypeSupported('audio/webm;codecs=opus'));
// false on chrome, true on firefox
console.log("audio/ogg:"+MediaRecorder.isTypeSupported('audio/ogg;codecs=opus'));

if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')){
	extension="webm";
}else{
	extension="ogg"
}


function startRecording() {
	console.log("recordButton clicked");
    var constraints = {audio: true}
	var options = {
	  audioBitsPerSecond :  128000,
	  mimeType : 'audio/'+extension+';codecs=opus'
	}
	recordButton.disabled = true;
	stopButton.disabled = false;
	
	navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
		console.log("getUserMedia() success, stream created, initializing MediaRecorder");

		/*  assign to gumStream for later use  */
		gumStream = stream;

	    //update the format 
		//document.getElementById("formats").innerHTML='Sample rate: 48kHz, MIME: audio/'+extension+';codecs=opus';

		/* 
			Create the MediaRecorder object
		*/
		recorder = new MediaRecorder(stream, options);

		//when data becomes available add it to our attay of audio data
	    recorder.ondataavailable = function(e){
	    	console.log("recorder.ondataavailable:" + e.data);
	    	console.log ("recorder.audioBitsPerSecond:"+recorder.audioBitsPerSecond)
	    	console.log ("recorder.bitsPerSecond:"+recorder.bitsPerSecond)
	      	// add stream data to chunks
	      	chunks.push(e.data);
	      	// if recorder is 'inactive' then recording has finished
	      	if (recorder.state == 'inactive') {
	          // convert stream data chunks to a 'webm' audio format as a blob
	          const blob = new Blob(chunks, { type: 'audio/'+extension, bitsPerSecond:128000});
	          createDownloadLink(blob)
	      	}
	    };

	    recorder.onerror = function(e){
	    	console.log(e.error);
	    }

	    //start recording using 1 second chunks
	    //Chrome and Firefox will record one long chunk if you do not specify the chunck length
	    recorder.start(1000);

    	//recorder.start();
    }).catch(function(err) {
	  	//enable the record button if getUserMedia() fails
    	recordButton.disabled = false;
    	stopButton.disabled = true;
	});
}

function stopRecording() {
	console.log("stopButton clicked");

	//disable the stop button, enable the record too allow for new recordings
	stopButton.disabled = true;
	recordButton.disabled = false;

	
	//tell the recorder to stop the recording
	recorder.stop();

	//stop microphone access
	gumStream.getAudioTracks()[0].stop();
}

function createDownloadLink(blob) {
	
	var url = URL.createObjectURL(blob);
    audio_player.src = url; 
}

</script>
</body>
</html> 